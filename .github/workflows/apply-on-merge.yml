name: 보안 파이프라인 - 03 Merge된 리메디에이션 적용

on:
  workflow_dispatch:
    inputs:
      categories:
        description: "Comma-separated categories (iam,s3,network-ec2-vpc,cloudtrail,cloudwatch)"
        required: false
        type: string
        default: ""
  push:
    branches: ["main"]
    paths:
      - "remediation/**"

concurrency:
  group: security-pipeline-03-apply-main
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Prepare scripts
        run: |
          chmod +x iac/scripts/*.sh || true
          sed -i 's/\r$//' iac/scripts/*.sh || true

      - name: Detect changed remediation categories
        id: cats
        shell: bash
        run: |
          VALID="iam s3 network-ec2-vpc cloudtrail cloudwatch"
          APPLY_ROOT="remediation"
          mkdir -p artifacts

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CATS="${{ inputs.categories }}"
            if [ -z "$CATS" ]; then
              CATS="iam,s3,network-ec2-vpc,cloudtrail,cloudwatch"
            fi
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            CHANGED_FILES="$(git diff --name-only "$BEFORE" "$AFTER" | awk '/^remediation\// {print}')"

            if [ -n "$CHANGED_FILES" ]; then
              # Any remediation file changed → apply ALL valid categories from current state.
              # Using APPLY_ROOT=remediation (not a diff-scoped copy) ensures stable-named
              # resources (e.g. CloudWatch log groups with same names after vuln infra recreate)
              # are not skipped just because their TF content is unchanged in the diff.
              CATS="iam,s3,network-ec2-vpc,cloudtrail,cloudwatch"
              APPLY_ROOT="remediation"
            else
              CATS=""
              APPLY_ROOT="remediation"
            fi
          fi

          FILTERED=""
          IFS=',' read -r -a raw <<< "$CATS"
          for c in "${raw[@]}"; do
            c="$(echo "$c" | tr -d '[:space:]')"
            [ -z "$c" ] && continue
            if echo " $VALID " | grep -q " $c "; then
              if [ ! -d "$APPLY_ROOT/$c" ] || ! find "$APPLY_ROOT/$c" -maxdepth 1 -name '*.tf' | grep -q .; then
                echo "skip category without tf files: $c"
                continue
              fi
              if [ -z "$FILTERED" ]; then
                FILTERED="$c"
              else
                FILTERED="$FILTERED,$c"
              fi
            fi
          done

          CATS="$FILTERED"
          echo "categories=$CATS" >> "$GITHUB_OUTPUT"
          echo "apply_root=$APPLY_ROOT" >> "$GITHUB_OUTPUT"
          echo "changed_categories=$CATS"
          echo "apply_root=$APPLY_ROOT"

      - name: Apply category by category
        run: |
          bash iac/scripts/resilient_apply.sh "${{ steps.cats.outputs.apply_root }}" artifacts "${{ steps.cats.outputs.categories }}"

      - name: Upload apply artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apply-${{ github.run_id }}
          path: artifacts/apply/
