name: Security Pipeline - 03 Apply Merged Generated Terraform Remediation

on:
  workflow_dispatch:
    inputs:
      categories:
        description: "Comma-separated categories (iam,s3,network-ec2-vpc,cloudtrail,cloudwatch)"
        required: false
        type: string
        default: ""
  push:
    branches: ["main"]
    paths:
      - "remediation/**"

concurrency:
  group: security-pipeline-03-apply-main
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  apply:
    runs-on: ubuntu-latest
    env:
      BUDGET_LIMIT_USD: "50"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Enforce budget guard
        run: |
          chmod +x iac/scripts/cost_guard.sh
          bash iac/scripts/cost_guard.sh "${BUDGET_LIMIT_USD}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Prepare scripts
        run: |
          chmod +x iac/scripts/*.sh || true
          sed -i 's/\r$//' iac/scripts/*.sh || true

      - name: Detect changed remediation categories
        id: cats
        shell: bash
        run: |
          VALID="iam s3 network-ec2-vpc cloudtrail cloudwatch"
          APPLY_ROOT="remediation"
          mkdir -p artifacts

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CATS="${{ inputs.categories }}"
            if [ -z "$CATS" ]; then
              CATS="iam,s3,network-ec2-vpc,cloudtrail,cloudwatch"
            fi
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            CHANGED_FILES="$(git diff --name-only "$BEFORE" "$AFTER" | awk '/^remediation\// {print}')"
            SCOPE="artifacts/apply_scope"
            rm -rf "$SCOPE"
            mkdir -p "$SCOPE"
            CHANGED_CATS=""

            while IFS= read -r f; do
              [ -z "$f" ] && continue
              cat="$(echo "$f" | awk -F/ '{print $2}')"
              if ! echo " $VALID " | grep -q " $cat "; then
                continue
              fi
              case ",$CHANGED_CATS," in
                *",$cat,"*) ;;
                *) CHANGED_CATS="${CHANGED_CATS:+$CHANGED_CATS,}$cat" ;;
              esac
              if [ ! -f "$f" ]; then
                echo "skip missing file in diff: $f"
                continue
              fi
              mkdir -p "$SCOPE/$cat"
              cp "$f" "$SCOPE/$cat/$(basename "$f")"
            done <<< "$CHANGED_FILES"

            IFS=',' read -r -a cats_arr <<< "$CHANGED_CATS"
            for cat in "${cats_arr[@]}"; do
              [ -z "$cat" ] && continue
              mkdir -p "$SCOPE/$cat"

              # If only manifest changed, include current tf set so apply can run on that category.
              if ! find "$SCOPE/$cat" -maxdepth 1 -name '*.tf' | grep -q .; then
                if [ -d "remediation/$cat" ]; then
                  cp remediation/"$cat"/*.tf "$SCOPE/$cat/" 2>/dev/null || true
                fi
              fi

              if [ -f "remediation/$cat/import-map.txt" ]; then
                mkdir -p "$SCOPE/$cat"
                cp "remediation/$cat/import-map.txt" "$SCOPE/$cat/import-map.txt"
              fi
            done

            CATS="$CHANGED_CATS"
            APPLY_ROOT="$SCOPE"
          fi

          FILTERED=""
          IFS=',' read -r -a raw <<< "$CATS"
          for c in "${raw[@]}"; do
            c="$(echo "$c" | tr -d '[:space:]')"
            [ -z "$c" ] && continue
            if echo " $VALID " | grep -q " $c "; then
              if [ ! -d "$APPLY_ROOT/$c" ] || ! find "$APPLY_ROOT/$c" -maxdepth 1 -name '*.tf' | grep -q .; then
                echo "skip category without tf files: $c"
                continue
              fi
              if [ -z "$FILTERED" ]; then
                FILTERED="$c"
              else
                FILTERED="$FILTERED,$c"
              fi
            fi
          done

          CATS="$FILTERED"
          echo "categories=$CATS" >> "$GITHUB_OUTPUT"
          echo "apply_root=$APPLY_ROOT" >> "$GITHUB_OUTPUT"
          echo "changed_categories=$CATS"
          echo "apply_root=$APPLY_ROOT"

      - name: Apply category by category
        run: |
          bash iac/scripts/resilient_apply.sh "${{ steps.cats.outputs.apply_root }}" artifacts "${{ steps.cats.outputs.categories }}"

      - name: Upload apply artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apply-${{ github.run_id }}
          path: artifacts/apply/
