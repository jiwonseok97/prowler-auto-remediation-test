name: Security Pipeline - 01 Scan Baseline

on:
  workflow_dispatch:
    inputs:
      deploy_vulnerable:
        description: "Deploy vulnerable infra before scan"
        required: true
        type: boolean
        default: true
      account_id:
        description: "Target AWS account id"
        required: true
        type: string
      compliance_mode:
        description: "Scan mode"
        required: true
        type: choice
        options:
          - cis_1.4_plus_isms_p
          - cis_1.4_only
        default: cis_1.4_plus_isms_p

concurrency:
  group: security-pipeline-01-scan-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-northeast-2
      AWS_ACCOUNT_ID: ${{ inputs.account_id }}
      TF_VAR_region: ap-northeast-2
      TF_VAR_account_id: ${{ inputs.account_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Deploy vulnerable infra
        if: inputs.deploy_vulnerable == true
        run: |
          terraform -chdir=terraform/vulnerable_infra_test init -input=false
          terraform -chdir=terraform/vulnerable_infra_test apply -auto-approve -input=false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install "prowler>=3.11,<4.0"

      - name: Run Prowler (Seoul + CIS/ISMS-P)
        run: |
          mkdir -p artifacts/scan
          prowler aws --region ap-northeast-2 --compliance cis_1.4_aws -M json-asff -o artifacts/scan -F baseline_cis || true
          if [ "${{ inputs.compliance_mode }}" = "cis_1.4_plus_isms_p" ]; then
            CHECKS="$(tr '\n' ' ' < iac/compliance/isms_p_checks.txt | xargs)"
            if [ -n "$CHECKS" ]; then
              prowler aws --region ap-northeast-2 -c $CHECKS -M json-asff -o artifacts/scan -F baseline_isms_p || true
            fi
          fi
          python iac/scripts/merge_prowler_outputs.py \
            --dir artifacts/scan \
            --prefix baseline \
            --output artifacts/scan/baseline.asff.json

      - name: Normalize and score findings
        run: |
          python iac/scripts/normalize_findings.py \
            --input artifacts/scan/baseline.asff.json \
            --output artifacts/scan/normalized_findings.json \
            --account-id "${{ inputs.account_id }}" \
            --region "ap-northeast-2"
          python iac/scripts/osfp_score.py \
            --input artifacts/scan/normalized_findings.json \
            --output artifacts/scan/prioritized_findings.json

      - name: Build scan manifest
        run: |
          python iac/scripts/write_scan_manifest.py \
            --normalized artifacts/scan/normalized_findings.json \
            --prioritized artifacts/scan/prioritized_findings.json \
            --output artifacts/scan/scan_manifest.json \
            --account-id "${{ inputs.account_id }}" \
            --region "ap-northeast-2" \
            --framework "${{ inputs.compliance_mode }}"

      - name: Optional publish baseline scan to external API
        continue-on-error: true
        env:
          PROWLER_APP_API_URL: ${{ secrets.PROWLER_APP_API_URL }}
          PROWLER_APP_API_TOKEN: ${{ secrets.PROWLER_APP_API_TOKEN }}
        run: |
          if [ -z "$PROWLER_APP_API_URL" ] || [ -z "$PROWLER_APP_API_TOKEN" ]; then
            echo "skip publish: PROWLER_APP_API_URL or PROWLER_APP_API_TOKEN is empty"
            exit 0
          fi
          python iac/scripts/publish_scan_to_api.py \
            --input artifacts/scan/scan_manifest.json \
            --event baseline_scan \
            --api-url "$PROWLER_APP_API_URL" \
            --api-token "$PROWLER_APP_API_TOKEN" \
            --repo "${{ github.repository }}" \
            --run-id "${{ github.run_id }}" \
            --account-id "${{ inputs.account_id }}" \
            --region "ap-northeast-2" \
            --framework "${{ inputs.compliance_mode }}"

      - name: Upload scan artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-${{ github.run_id }}
          path: artifacts/scan/

      - name: Summary
        run: |
          python - <<'PY'
          import json, glob, re
          from pathlib import Path
          from collections import defaultdict, Counter

          CIS_LOGO  = '<img src="https://raw.githubusercontent.com/jiwonseok97/prowler-auto-remediation-test/main/.github/assets/cis-logo.svg" alt="CIS" height="40">'
          ISMS_LOGO = '<img src="https://raw.githubusercontent.com/jiwonseok97/prowler-auto-remediation-test/main/.github/assets/isms-logo.jpg" alt="ISMS-P" height="50">'

          def extract_service(f):
              pf = f.get('ProductFields', {})
              svc = (pf.get('ServiceName') or pf.get('aws/service') or '').lower().strip()
              if svc and svc not in ('unknown', ''):
                  return svc
              gen_id = (f.get('GeneratorId') or '').lower()
              m = re.search(r'prowler-([a-z][a-z0-9]+)_', gen_id)
              if m:
                  return m.group(1)
              return 'unknown'

          def parse_asff(pattern):
              findings = []
              for fn in sorted(glob.glob(pattern)):
                  try:
                      data = json.loads(Path(fn).read_text(encoding='utf-8'))
                      findings.extend(data if isinstance(data, list) else data.get('Findings', []))
                  except Exception:
                      pass
              return findings

          def make_compliance_table(findings, logo_html, title, acct):
              if not findings:
                  return f'{logo_html}\n\n**{title}**\n\n_스캔 결과 없음_\n'
              svc_data = defaultdict(lambda: {'pass': 0, 'fail': 0, 'critical': 0, 'high': 0, 'medium': 0, 'low': 0})
              for f in findings:
                  if not acct:
                      acct = f.get('AwsAccountId', '')
                  svc = extract_service(f)
                  status = f.get('Compliance', {}).get('Status', '')
                  sev = f.get('Severity', {}).get('Label', '').lower()
                  if status == 'FAILED':
                      svc_data[svc]['fail'] += 1
                      if sev in ('critical', 'high', 'medium', 'low'):
                          svc_data[svc][sev] += 1
                  elif status in ('PASSED', 'WARNING'):
                      svc_data[svc]['pass'] += 1
              total_fail = sum(v['fail'] for v in svc_data.values())
              total_pass = sum(v['pass'] for v in svc_data.values())
              total = total_fail + total_pass
              fp = round(100 * total_fail / total, 2) if total > 0 else 0
              pp = round(100 * total_pass / total, 2) if total > 0 else 0
              lines = [
                  logo_html, '',
                  f'**{title}**', '',
                  '| 미준수 | 준수 |', '|---|---|',
                  f'| {fp}% ({total_fail}건) | {pp}% ({total_pass}건) |', '',
                  f'계정 {acct} 스캔 결과 _(심각도 컬럼은 FAIL 항목에만 적용)_', '',
                  '| 공급자 | 서비스 | 상태 | Critical | High | Medium | Low |',
                  '|---|---|---|---:|---:|---:|---:|',
              ]
              for svc in sorted(svc_data.keys()):
                  v = svc_data[svc]
                  st = f'미준수 ({v["fail"]})' if v['fail'] > 0 else f'준수 ({v["pass"]})'
                  lines.append(f'| aws | `{svc}` | {st} | {v["critical"]} | {v["high"]} | {v["medium"]} | {v["low"]} |')
              return '\n'.join(lines)

          CHECK_DESCRIPTIONS = {
              'prowler-s3_bucket_no_mfa_delete':           'S3 버킷 MFA Delete 비활성화 — 객체 삭제 시 MFA 인증이 요구되지 않아 실수/악의적 삭제에 취약',
              'prowler-iam_root_hardware_mfa_enabled':      '루트 계정 하드웨어 MFA 미설정 — 루트 계정 탈취 시 전체 AWS 계정 위험 노출',
              'prowler-iam_password_policy_minimum_length_14': 'IAM 패스워드 최소 길이 14자 미만 — 무차별 대입 공격에 취약',
              'prowler-iam_password_policy_reuse_24':       'IAM 패스워드 재사용 제한 24회 미만 — 이전 패스워드 재사용 가능',
              'prowler-iam_password_policy_lowercase':      'IAM 패스워드 소문자 요구 조건 미설정',
              'prowler-iam_password_policy_number':         'IAM 패스워드 숫자 요구 조건 미설정',
              'prowler-iam_password_policy_symbol':         'IAM 패스워드 특수문자 요구 조건 미설정',
              'prowler-iam_password_policy_uppercase':      'IAM 패스워드 대문자 요구 조건 미설정',
              'prowler-ec2_ebs_volume_encryption':          'EBS 볼륨 미암호화 — 저장 데이터 평문으로 물리적 접근 시 데이터 유출 위험',
              'prowler-ec2_instance_profile_attached':      'EC2 인스턴스 IAM 프로파일 미연결 — 액세스 키 하드코딩 위험 증가',
          }

          p = Path('artifacts/scan/prioritized_findings.json')
          rows = json.loads(p.read_text(encoding='utf-8')) if p.exists() else []
          fail_rows = [r for r in rows if r.get('status') == 'FAIL']
          fail = len(fail_rows)
          by_check = Counter(str(r.get('check_id', 'unknown')) for r in fail_rows)

          manifest = Path('artifacts/scan/scan_manifest.json')
          acct = ''
          if manifest.exists():
              m = json.loads(manifest.read_text(encoding='utf-8'))
              acct = m.get('account') or m.get('account_id') or ''

          cis_findings  = parse_asff('artifacts/scan/baseline_cis*.json')
          isms_findings = parse_asff('artifacts/scan/baseline_isms_p*.json')

          check_lines = ['| 점검 항목 ID | Fail 수 |', '|---|---:|']
          for cid, cnt in by_check.most_common():
              check_lines.append(f'| `{cid}` | {cnt} |')

          desc_lines = []
          if by_check:
              desc_lines.append('\n**FAIL 항목 요약:**')
              for cid in by_check.keys():
                  desc = CHECK_DESCRIPTIONS.get(cid, '해당 보안 항목이 설정 기준에 미달합니다.')
                  desc_lines.append(f'- `{cid}`: {desc}')

          print(f'baseline_fail={fail}')

          with open(Path.cwd() / 'summary.md', 'w', encoding='utf-8') as f:
              f.write('## 01. 베이스라인 스캔 결과\n')
              f.write(f'- 기준선 FAIL 항목 수: {fail}\n\n')
              f.write('---\n\n')
              if cis_findings:
                  f.write(make_compliance_table(cis_findings, CIS_LOGO, 'CIS Amazon Web Services Foundations Benchmark v1.4', acct) + '\n\n')
                  f.write('---\n\n')
              if isms_findings:
                  f.write(make_compliance_table(isms_findings, ISMS_LOGO, 'ISMS-P 정보보호 관리체계 인증', acct) + '\n\n')
                  f.write('---\n\n')
              f.write('### 점검 항목별 FAIL 현황\n')
              f.write('\n'.join(check_lines) + '\n')
              if desc_lines:
                  f.write('\n'.join(desc_lines) + '\n')
          PY
          cat summary.md >> "$GITHUB_STEP_SUMMARY"
