name: Security Pipeline - IaC Scanners (Checkov)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "terraform/**"
      - "iac/**"
      - "remediation/**"
      - ".github/workflows/security-pipeline-iac-scanners.yml"

permissions:
  contents: read
  security-events: write

jobs:
  iac-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare result directory
        run: mkdir -p artifacts/iac-scanners

      - name: Install Checkov
        run: |
          python -m pip install --upgrade pip
          pip install checkov

      - name: Run Checkov
        continue-on-error: true
        run: |
          checkov -d terraform -o json > artifacts/iac-scanners/checkov-terraform.json || true
          checkov -d remediation -o json > artifacts/iac-scanners/checkov-remediation.json || true

      - name: Build scan summary
        run: |
          python - <<'PY'
          from pathlib import Path
          root = Path("artifacts/iac-scanners")
          files = sorted(p.name for p in root.glob("*.json"))
          lines = ["## IaC Scanner Summary", "", "| Tool/Scope | Output file |", "|---|---|"]
          for f in files:
              # checkov-terraform.json / checkov-remediation.json
              lines.append(f"| `checkov` | `{f}` |")
          if not files:
              lines.append("| none | none |")
          md = "\n".join(lines) + "\n"
          (root / "summary.md").write_text(md, encoding="utf-8")
          print(md)
          PY
          cat artifacts/iac-scanners/summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload IaC scanner artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iac-scanners-${{ github.run_id }}
          path: artifacts/iac-scanners/