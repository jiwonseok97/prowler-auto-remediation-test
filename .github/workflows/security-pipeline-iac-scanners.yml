name: Security Pipeline - IaC Scanners (Checkov/tfsec/Terrascan/Snyk)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "terraform/**"
      - "iac/**"
      - "remediation/**"
      - ".github/workflows/security-pipeline-iac-scanners.yml"

permissions:
  contents: read
  security-events: write

jobs:
  iac-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare result directory
        run: mkdir -p artifacts/iac-scanners

      - name: Install scanner dependencies
        run: |
          python -m pip install --upgrade pip
          pip install checkov
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          wget -qO terrascan.tar.gz https://github.com/tenable/terrascan/releases/download/v1.19.9/terrascan_1.19.9_Linux_x86_64.tar.gz
          tar -xzf terrascan.tar.gz terrascan
          sudo mv terrascan /usr/local/bin/terrascan
          npm install -g snyk

      - name: Run Checkov
        continue-on-error: true
        run: |
          checkov -d terraform -o json > artifacts/iac-scanners/checkov-terraform.json || true
          checkov -d remediation -o json > artifacts/iac-scanners/checkov-remediation.json || true

      - name: Run tfsec
        continue-on-error: true
        run: |
          tfsec terraform --format json --out artifacts/iac-scanners/tfsec-terraform.json || true
          tfsec remediation --format json --out artifacts/iac-scanners/tfsec-remediation.json || true

      - name: Run Terrascan
        continue-on-error: true
        run: |
          terrascan scan -d terraform -o json > artifacts/iac-scanners/terrascan-terraform.json || true
          terrascan scan -d remediation -o json > artifacts/iac-scanners/terrascan-remediation.json || true

      - name: Run Snyk IaC (optional)
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo '{"status":"skipped","reason":"missing SNYK_TOKEN"}' > artifacts/iac-scanners/snyk-iac.json
            exit 0
          fi
          snyk auth "$SNYK_TOKEN"
          snyk iac test terraform --json-file-output=artifacts/iac-scanners/snyk-terraform.json || true
          snyk iac test remediation --json-file-output=artifacts/iac-scanners/snyk-remediation.json || true

      - name: Build scan summary
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          root = Path("artifacts/iac-scanners")
          files = sorted(p.name for p in root.glob("*.json"))
          lines = ["## IaC Scanner Summary", "", "| Tool/Scope | Output file |", "|---|---|"]
          for f in files:
              lines.append(f"| `{f.split('-')[0]}` | `{f}` |")
          if not files:
              lines.append("| none | none |")
          md = "\n".join(lines) + "\n"
          (root / "summary.md").write_text(md, encoding="utf-8")
          print(md)
          PY
          cat artifacts/iac-scanners/summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload IaC scanner artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iac-scanners-${{ github.run_id }}
          path: artifacts/iac-scanners/
