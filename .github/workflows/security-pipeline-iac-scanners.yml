name: ?? ????? - IaC ?? ?? ?? (Checkov)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "terraform/**"
      - "iac/**"
      - "remediation/**"
      - ".github/workflows/security-pipeline-iac-scanners.yml"

permissions:
  contents: read
  security-events: write

jobs:
  iac-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare result directory
        run: mkdir -p artifacts/iac-scanners

      - name: Install Checkov
        run: |
          python -m pip install --upgrade pip
          pip install checkov

      # -------------------------------------------------------
      # Checkov – terraform/ (취약 인프라 배포 코드)
      # -------------------------------------------------------
      - name: Run Checkov on terraform/
        continue-on-error: true
        run: |
          checkov -d terraform \
            -o json \
            -o sarif \
            --output-file-path artifacts/iac-scanners \
            --output-filename checkov-terraform \
            --quiet || true

          python - <<'PY'
          import json, sys
          from pathlib import Path
          from collections import defaultdict

          p = Path("artifacts/iac-scanners/checkov-terraform.json")
          if not p.exists():
              print("no output"); sys.exit(0)
          data = json.loads(p.read_text(encoding="utf-8"))
          if isinstance(data, list):
              passed = [r for b in data for r in b.get("results",{}).get("passed_checks",[])]
              failed = [r for b in data for r in b.get("results",{}).get("failed_checks",[])]
          else:
              passed = data.get("results",{}).get("passed_checks",[])
              failed = data.get("results",{}).get("failed_checks",[])
          total = len(passed) + len(failed)
          rate  = len(passed)/total*100 if total else 0
          sev   = defaultdict(int)
          for f in failed:
              sev[(f.get("severity") or "UNKNOWN").upper()] += 1
          print(f"terraform passed={len(passed)} failed={len(failed)} rate={rate:.1f}%")
          for sv, cnt in sorted(sev.items()):
              print(f"  {sv}: {cnt}")
          PY

      # -------------------------------------------------------
      # Checkov – remediation/ (자동 생성 보안 수정 코드)
      # -------------------------------------------------------
      - name: Run Checkov on remediation/
        continue-on-error: true
        run: |
          checkov -d remediation \
            -o json \
            -o sarif \
            --output-file-path artifacts/iac-scanners \
            --output-filename checkov-remediation \
            --quiet || true

          python - <<'PY'
          import json, sys
          from pathlib import Path

          p = Path("artifacts/iac-scanners/checkov-remediation.json")
          if not p.exists():
              print("no output"); sys.exit(0)
          data = json.loads(p.read_text(encoding="utf-8"))
          if isinstance(data, list):
              passed = [r for b in data for r in b.get("results",{}).get("passed_checks",[])]
              failed = [r for b in data for r in b.get("results",{}).get("failed_checks",[])]
          else:
              passed = data.get("results",{}).get("passed_checks",[])
              failed = data.get("results",{}).get("failed_checks",[])
          total = len(passed) + len(failed)
          rate  = len(passed)/total*100 if total else 0
          print(f"remediation passed={len(passed)} failed={len(failed)} rate={rate:.1f}%")
          PY

      # -------------------------------------------------------
      # SARIF → GitHub Code Scanning 업로드
      # -------------------------------------------------------
      - name: Upload terraform SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: artifacts/iac-scanners/checkov-terraform.sarif
          category: checkov-terraform
        continue-on-error: true

      - name: Upload remediation SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: artifacts/iac-scanners/checkov-remediation.sarif
          category: checkov-remediation
        continue-on-error: true

      # -------------------------------------------------------
      # Before/After 비교 요약 (Step Summary)
      # -------------------------------------------------------
      - name: Build scan summary
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          from collections import defaultdict

          root = Path("artifacts/iac-scanners")

          def load(fname):
              p = root / fname
              if not p.exists():
                  return [], []
              data = json.loads(p.read_text(encoding="utf-8"))
              if isinstance(data, list):
                  passed = [r for b in data for r in b.get("results",{}).get("passed_checks",[])]
                  failed = [r for b in data for r in b.get("results",{}).get("failed_checks",[])]
              else:
                  passed = data.get("results",{}).get("passed_checks",[])
                  failed = data.get("results",{}).get("failed_checks",[])
              return passed, failed

          tf_pass,  tf_fail  = load("checkov-terraform.json")
          rem_pass, rem_fail = load("checkov-remediation.json")

          tf_total  = len(tf_pass)  + len(tf_fail)
          rem_total = len(rem_pass) + len(rem_fail)
          tf_rate   = len(tf_pass)  / tf_total  * 100 if tf_total  else 0
          rem_rate  = len(rem_pass) / rem_total * 100 if rem_total else 0

          check_map = defaultdict(int)
          res_map   = defaultdict(int)
          for f in tf_fail:
              check_map[f.get("check_id","?")] += 1
              res_map[f.get("resource","?").split(".")[0]] += 1
          top_checks    = sorted(check_map.items(), key=lambda x: -x[1])[:10]
          top_resources = sorted(res_map.items(),   key=lambda x: -x[1])[:5]

          md  = "## IaC Scanner (Checkov) 결과 요약\n\n"
          md += "### Before vs After 비교\n\n"
          md += "| 스캔 대상 | 총 항목 | PASS | FAIL | 통과율 |\n"
          md += "|---|---:|---:|---:|---:|\n"
          md += f"| 취약 인프라 코드 (`terraform/`) | {tf_total} | {len(tf_pass)} | {len(tf_fail)} | **{tf_rate:.1f}%** |\n"
          md += f"| 보안 수정 코드 (`remediation/`) | {rem_total} | {len(rem_pass)} | {len(rem_fail)} | **{rem_rate:.1f}%** |\n"
          md += f"\n> ✅ 보안 수정 코드 Checkov 통과율 **{rem_rate:.1f}%** — 취약 코드 대비 +**{rem_rate-tf_rate:.1f}%p** 개선\n\n"

          md += "### terraform/ Top Failing Checks\n\n"
          md += "| Check ID | 위반 건수 |\n|---|---:|\n"
          for cid, cnt in top_checks:
              md += f"| `{cid}` | {cnt} |\n"

          md += "\n### 영향 리소스 유형 (terraform/)\n\n"
          md += "| Resource Type | FAIL 건수 |\n|---|---:|\n"
          for rt, cnt in top_resources:
              md += f"| `{rt}` | {cnt} |\n"

          md += "\n### GitHub Code Scanning 통합\n\n"
          md += "| 기능 | 상태 |\n|---|---|\n"
          md += "| Checkov JSON 아티팩트 | ✅ 저장됨 |\n"
          md += "| SARIF → Code Scanning | ✅ 업로드됨 |\n"
          md += "| PR Gate 트리거 | ✅ 활성 |\n"
          md += "| Before/After 비교 | ✅ 이 요약 |\n"

          (root / "summary.md").write_text(md, encoding="utf-8")
          print(md)
          PY
          cat artifacts/iac-scanners/summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload IaC scanner artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iac-scanners-${{ github.run_id }}
          path: artifacts/iac-scanners/
