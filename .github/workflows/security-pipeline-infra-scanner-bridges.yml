name: Security Pipeline - Infra Scanner Bridges (OpenVAS)

on:
  workflow_dispatch:
    inputs:
      target_host:
        description: "ìŠ¤ìº” ëŒ€ìƒ IP ë˜ëŠ” FQDN (í•„ìˆ˜)"
        required: true
        type: string
      openvas_timeout:
        description: "OpenVAS ìŠ¤ìº” ìµœëŒ€ ëŒ€ê¸° ì‹œê°„(ì´ˆ)"
        required: false
        type: string
        default: "3600"
      run_nessus_real_scan:
        description: "Run real Nessus API scan lifecycle (create/launch/poll/export)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  openvas-scan:
    runs-on: ubuntu-latest
    env:
      OPENVAS_HOST:     ${{ secrets.OPENVAS_HOST }}
      OPENVAS_PORT:     ${{ secrets.OPENVAS_PORT }}
      OPENVAS_USERNAME: ${{ secrets.OPENVAS_USERNAME }}
      OPENVAS_PASSWORD: ${{ secrets.OPENVAS_PASSWORD }}
      OPENVAS_TARGET:   ${{ inputs.target_host }}
      OPENVAS_TIMEOUT_SEC: ${{ inputs.openvas_timeout }}
      OPENVAS_OUT_DIR:  artifacts/openvas
    steps:
      - uses: actions/checkout@v4

      - name: Prepare output directories
        run: mkdir -p artifacts/openvas artifacts/infra-scanners

      # -------------------------------------------------------
      # OpenVAS ì „ì œì¡°ê±´ í™•ì¸
      # -------------------------------------------------------
      - name: Check OpenVAS prerequisites
        id: openvas_check
        run: |
          if [ -z "$OPENVAS_HOST" ] || [ -z "$OPENVAS_PASSWORD" ]; then
            echo "openvas_ready=false" >> "$GITHUB_OUTPUT"
            echo "## âš ï¸ OpenVAS ì„¤ì • ëˆ„ë½" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "ë‹¤ìŒ GitHub Secretsë¥¼ ì„¤ì •í•˜ì„¸ìš”:" >> "$GITHUB_STEP_SUMMARY"
            echo "| Secret | ì„¤ëª… | ì˜ˆì‹œ |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---|---|---|" >> "$GITHUB_STEP_SUMMARY"
            echo "| \`OPENVAS_HOST\` | GVM ì„œë²„ í˜¸ìŠ¤íŠ¸ | \`10.0.0.5\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| \`OPENVAS_PORT\` | GMP í¬íŠ¸ | \`9390\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| \`OPENVAS_USERNAME\` | ë¡œê·¸ì¸ ì‚¬ìš©ìž | \`admin\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| \`OPENVAS_PASSWORD\` | ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ | (í•„ìˆ˜) |" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          echo "openvas_ready=true" >> "$GITHUB_OUTPUT"
          echo "target=${{ inputs.target_host }}" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------------
      # gvm-tools ì„¤ì¹˜
      # -------------------------------------------------------
      - name: Install gvm-tools
        if: steps.openvas_check.outputs.openvas_ready == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install gvm-tools

      # -------------------------------------------------------
      # OpenVAS GMP ìŠ¤ìº” ì‹¤í–‰
      # -------------------------------------------------------
      - name: Run OpenVAS scan (GMP)
        if: steps.openvas_check.outputs.openvas_ready == 'true'
        id: openvas_run
        continue-on-error: true
        run: |
          python iac/scripts/openvas_scan.py
          if [ -f artifacts/openvas/openvas-summary.md ]; then
            cat artifacts/openvas/openvas-summary.md >> "$GITHUB_STEP_SUMMARY"
          fi

      # -------------------------------------------------------
      # ê²°ê³¼ ìš”ì•½ (JSON â†’ Step Summary)
      # -------------------------------------------------------
      - name: Build OpenVAS result summary
        if: always()
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          from collections import defaultdict

          out = Path("artifacts/openvas")
          out.mkdir(parents=True, exist_ok=True)
          p = out / "openvas-report.json"
          if not p.exists():
              summary_md = "## OpenVAS ìŠ¤ìº” ê²°ê³¼\n\n> ìŠ¤ìº”ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ê²°ê³¼ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.\n"
              (out / "openvas-summary.md").write_text(summary_md, encoding="utf-8")
              print(summary_md)
              exit(0)

          s = json.loads(p.read_text(encoding="utf-8"))
          cves = sorted({cve for r in s.get("results",[]) for cve in r.get("cve",[]) if cve})

          md  = f"## OpenVAS ìŠ¤ìº” ê²°ê³¼ ìš”ì•½\n\n"
          md += f"- **ëŒ€ìƒ:** `{s.get('scan_target','')}`\n"
          md += f"- **ì¼ì‹œ:** {s.get('scan_date','')}\n"
          md += f"- **ì´ ì·¨ì•½ì :** {s.get('total', 0)}ê±´\n\n"
          md += f"| ë“±ê¸‰ | ê±´ìˆ˜ |\n|---|---:|\n"
          md += f"| ðŸ”´ CRITICAL | {s.get('critical',0)} |\n"
          md += f"| ðŸŸ  HIGH     | {s.get('high',0)} |\n"
          md += f"| ðŸŸ¡ MEDIUM   | {s.get('medium',0)} |\n"
          md += f"| ðŸŸ¢ LOW      | {s.get('low',0)} |\n"
          md += f"| â„¹ï¸ INFO     | {s.get('info',0)} |\n\n"

          if cves:
              md += f"### ì‹ë³„ëœ CVE ({len(cves)}ê±´)\n\n"
              md += ", ".join(f"`{c}`" for c in cves[:20])
              if len(cves) > 20:
                  md += f" ... ì™¸ {len(cves)-20}ê±´"
              md += "\n\n"

          results = s.get("results", [])
          if results:
              md += "### ìƒìœ„ ì·¨ì•½ì  (CVSS ê¸°ì¤€)\n\n"
              md += "| CVSS | ë“±ê¸‰ | ì·¨ì•½ì ëª… | í¬íŠ¸ |\n|---:|---|---|---|\n"
              for r in results[:10]:
                  md += f"| {r.get('severity',0):.1f} | {r.get('cvss','')} | {r.get('name','')[:55]} | `{r.get('port','')}` |\n"

          (out / "openvas-summary.md").write_text(md, encoding="utf-8")
          print(md)
          PY
          cat artifacts/openvas/openvas-summary.md >> "$GITHUB_STEP_SUMMARY" || true

      # -------------------------------------------------------
      # ë¸Œë¦¬ì§€ ë„êµ¬ ì—°ê²° ìƒíƒœ ì ê²€ (Nessus/Qualys/InsightVM í¬í•¨)
      # -------------------------------------------------------
      - name: Build infra bridge readiness report
        env:
          TARGET_HOST:       ${{ inputs.target_host }}
          NESSUS_URL:        ${{ secrets.NESSUS_URL }}
          NESSUS_API_KEY:    ${{ secrets.NESSUS_API_KEY }}
          NESSUS_ACCESS_KEY: ${{ secrets.NESSUS_ACCESS_KEY }}
          NESSUS_SECRET_KEY: ${{ secrets.NESSUS_SECRET_KEY }}
          QUALYS_API_URL:    ${{ secrets.QUALYS_API_URL }}
          QUALYS_USERNAME:   ${{ secrets.QUALYS_USERNAME }}
          QUALYS_PASSWORD:   ${{ secrets.QUALYS_PASSWORD }}
          INSIGHTVM_URL:     ${{ secrets.INSIGHTVM_URL }}
          INSIGHTVM_API_KEY: ${{ secrets.INSIGHTVM_API_KEY }}
          OPENVAS_URL:       ${{ secrets.OPENVAS_HOST }}
          OPENVAS_USERNAME:  ${{ secrets.OPENVAS_USERNAME }}
          OPENVAS_PASSWORD:  ${{ secrets.OPENVAS_PASSWORD }}
          INFRA_SCANNER_OUT_DIR: artifacts/infra-scanners
        run: |
          python iac/scripts/infra_bridge_report.py
          cat artifacts/infra-scanners/summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload scan artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: infra-scanner-bridges-${{ github.run_id }}
          path: |
            artifacts/openvas/
            artifacts/infra-scanners/
