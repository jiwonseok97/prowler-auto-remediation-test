name: Security Pipeline - Infra Scanner Bridges (Nessus/Qualys/InsightVM/OpenVAS)

on:
  workflow_dispatch:
    inputs:
      target_host:
        description: "Target host/IP for infra scan tools (optional)"
        required: false
        type: string
        default: ""
      run_nessus_real_scan:
        description: "Run real Nessus API scan lifecycle (create/launch/poll/export)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  infra-bridge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare output
        run: mkdir -p artifacts/infra-scanners

      - name: Build bridge readiness report
        env:
          NESSUS_URL: ${{ secrets.NESSUS_URL }}
          NESSUS_API_KEY: ${{ secrets.NESSUS_API_KEY }}
          NESSUS_ACCESS_KEY: ${{ secrets.NESSUS_ACCESS_KEY }}
          NESSUS_SECRET_KEY: ${{ secrets.NESSUS_SECRET_KEY }}
          QUALYS_API_URL: ${{ secrets.QUALYS_API_URL }}
          QUALYS_USERNAME: ${{ secrets.QUALYS_USERNAME }}
          QUALYS_PASSWORD: ${{ secrets.QUALYS_PASSWORD }}
          INSIGHTVM_URL: ${{ secrets.INSIGHTVM_URL }}
          INSIGHTVM_API_KEY: ${{ secrets.INSIGHTVM_API_KEY }}
          OPENVAS_URL: ${{ secrets.OPENVAS_URL }}
          OPENVAS_USERNAME: ${{ secrets.OPENVAS_USERNAME }}
          OPENVAS_PASSWORD: ${{ secrets.OPENVAS_PASSWORD }}
          TARGET_HOST: ${{ inputs.target_host }}
        run: |
          python iac/scripts/infra_bridge_report.py
          cat artifacts/infra-scanners/summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Run Nessus real scan lifecycle
        if: ${{ inputs.run_nessus_real_scan == true && secrets.NESSUS_URL != '' && inputs.target_host != '' && (secrets.NESSUS_API_KEY != '' || (secrets.NESSUS_ACCESS_KEY != '' && secrets.NESSUS_SECRET_KEY != '')) }}
        env:
          NESSUS_URL: ${{ secrets.NESSUS_URL }}
          NESSUS_API_KEY: ${{ secrets.NESSUS_API_KEY }}
          NESSUS_ACCESS_KEY: ${{ secrets.NESSUS_ACCESS_KEY }}
          NESSUS_SECRET_KEY: ${{ secrets.NESSUS_SECRET_KEY }}
          TARGET_HOST: ${{ inputs.target_host }}
          NESSUS_VERIFY_TLS: "false"
          NESSUS_DELETE_SCAN: "false"
        run: |
          python iac/scripts/nessus_scan_bridge.py \
            --target-host "${{ inputs.target_host }}" \
            --out-dir artifacts/infra-scanners/nessus \
            --poll-interval 15 \
            --timeout-sec 3600
          cat artifacts/infra-scanners/nessus/nessus_summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Nessus real scan prerequisites warning
        if: ${{ inputs.run_nessus_real_scan == true && (inputs.target_host == '' || secrets.NESSUS_URL == '' || (secrets.NESSUS_API_KEY == '' && (secrets.NESSUS_ACCESS_KEY == '' || secrets.NESSUS_SECRET_KEY == ''))) }}
        run: |
          {
            echo "## Nessus Real Scan Skipped"
            echo ""
            echo "- run_nessus_real_scan: \`${{ inputs.run_nessus_real_scan }}\`"
            echo "- target_host set: \`${{ inputs.target_host != '' }}\`"
            echo "- NESSUS_URL set: \`${{ secrets.NESSUS_URL != '' }}\`"
            echo "- auth set (api or access+secret): \`${{ secrets.NESSUS_API_KEY != '' || (secrets.NESSUS_ACCESS_KEY != '' && secrets.NESSUS_SECRET_KEY != '') }}\`"
            echo ""
            echo "Set missing input/secrets and rerun."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Optional endpoint connectivity checks
        continue-on-error: true
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          p = Path("artifacts/infra-scanners/ready-urls.json")
          rows = json.loads(p.read_text(encoding="utf-8")) if p.exists() else []
          Path("artifacts/infra-scanners/connectivity.txt").write_text("", encoding="utf-8")
          if not rows:
            with open("artifacts/infra-scanners/connectivity.txt", "a", encoding="utf-8") as f:
              f.write("no ready endpoints to test\n")
          for r in rows:
            tool = r.get("tool", "unknown")
            url = r.get("url", "")
            if not url:
              continue
            print(f"checking {tool}: {url}")
          PY
          if [ -f artifacts/infra-scanners/ready-urls.json ]; then
            jq -r '.[] | "\(.tool)\t\(.url)"' artifacts/infra-scanners/ready-urls.json | while IFS=$'\t' read -r tool url; do
              [ -z "$url" ] && continue
              code="$(curl -k -L -sS -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 "$url" || echo 000)"
              echo "${tool}|${url}|${code}" >> artifacts/infra-scanners/connectivity.txt
            done
          fi
          {
            echo ""
            echo "## Infra Endpoint Connectivity"
            echo ""
            echo "| Tool | URL | HTTP |"
            echo "|---|---|---:|"
            if [ -f artifacts/infra-scanners/connectivity.txt ]; then
              while IFS='|' read -r tool url code; do
                [ -z "$tool" ] && continue
                echo "| \`$tool\` | \`$url\` | $code |"
              done < artifacts/infra-scanners/connectivity.txt
            else
              echo "| none | n/a | n/a |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload infra scanner artifacts
        uses: actions/upload-artifact@v4
        with:
          name: infra-scanner-bridges-${{ github.run_id }}
          path: artifacts/infra-scanners/
